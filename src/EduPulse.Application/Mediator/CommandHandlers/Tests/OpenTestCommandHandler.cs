using EduPulse.Application.Abstractions;
using EduPulse.Application.Common.Mediator;
using EduPulse.Application.Dtos;
using EduPulse.Application.Mediator.Commands.Tests;
using EduPulse.Domain.Common;
using EduPulse.Domain.Entities;
using EduPulse.Domain.Enums;

namespace EduPulse.Application.Mediator.CommandHandlers.Tests;

public class OpenTestCommandHandler : CommandHandlerBase<OpenTestCommand, TestDto>
{
    private readonly IRepository<TestEntity> _testsRepository;
    private readonly IEventsPublisher _eventsPublisher;

    public OpenTestCommandHandler(
        IRepository<TestEntity> testsRepository,
        IEventsPublisher eventsPublisher
        )
    {
        _testsRepository = testsRepository;
        _eventsPublisher = eventsPublisher;
    }

    public override async Task<TestDto> Handle(OpenTestCommand command, CancellationToken cancellationToken)
    {
        var testEntity = await _testsRepository.SingleAsync(test => test.Id == command.Id, cancellationToken);

        testEntity.Status = TestStatus.Opened;

        var testDto = await _testsRepository.UpdateAsync<TestDto>(testEntity, cancellationToken);
        
        await _eventsPublisher.PublishAsync(new EventDto<TestOpenedEventDto>
        {
            Channel = "tests.opened",
            Data = new TestOpenedEventDto
            {
                TestId = testEntity.Id
            }
        }, cancellationToken);

        return testDto;
    }
}